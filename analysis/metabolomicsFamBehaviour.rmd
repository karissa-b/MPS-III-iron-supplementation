---
title: "metabolomicsFamBehaviour"
author: "Karissa Barthelson"
date: "2024-02-24"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r packages}
library(tidyverse)
library(readxl)
library(here)
library(magrittr)
library(scales)
library(readxl)

# vis
library(ggpubr)
library(ggeasy)
library(ggfortify)
library(ggbeeswarm)
library(ggforce)
library(ggrepel)
library(ggfortify)
library(kableExtra)
library(colorspace)

# stat analysis
library(broom)
library(lme4)
library(performance)
library(car)
library(emmeans)
library(glmmTMB)
library(MASS)

# set the default theme for ggplot as theme_bw
theme_set(theme_classic())
```
## Introduction
```{r}
# read in the processed data and metadata
# fix up column names and types
meta <- 
  read_xlsx("data/ymaze/metabolomics_fam/2023_03_27 FeCit in naglu hom x het 6m MPS society meta.xlsx") %>% 
  mutate(fish_id = as.character(fish_id), 
         genotype = factor(genotype, levels = c("het", "hom")),
         sex = as.factor(sex),
         treatment = factor(treatment, 
                            levels = c("0.85% saline", 
                                       "10 µg FeCit")),
         start.time = as.factor(`start time`), 
         HomeTank = as.factor(HomeTank), 
         behavBatch = as.character(behavBatch), 
         ymazePosition = as.character(ymazePosition)
  ) %>% 
  dplyr::select(-`start time`) # remove unnecceasry columns

final_data <- read_csv("data/ymaze/metabolomics_fam/processed_data/final_output.csv") %>% 
  dplyr::select(-1) %>% 
  mutate(fish_id = factor(fish_id)) %>% 
  left_join(meta) %>% 
  dplyr::filter(genotype%in% c("het", "hom"))
#view(final_data)

# make an object which converts the final data to long format. for easier plotting in ggplot
final_data_long <- final_data %>%
  gather(key = "tetras", value = "Count", # convert to long format
         grep("[L|R]{4}", 
              colnames(.))
         )

# also make an object which sums the tetragrams over the hour
final_data_summedoverbins <- final_data %>%
  gather(key = "tetras", value = "Count", # convert to long format
         grep("[L|R]{4}", # select the columns which contain a L or a R four times
              colnames(.))
         ) %>% 
  group_by(fish_id, tetras) %>% 
  mutate(x = sum(Count)) %>% # sum the tetragram counts per fish_id
  dplyr::select(colnames(meta), tetras, x) %>% 
  unique
```

# assess whether tracking worked correctly. 

When assesssing behavioural tracking data, it is important to check whether the tracking of your animal was correct. I saved the tracking videos for watching, but also I will check the data to see whether any abnormailies are present.

From my previous experiennce with zebrafish in a y-maze, fish do not make more than 200 turns per 10 mins in the Y-maze. Plotting out the total number of turns per fish per 10 minute bin show a couple of fish looking very busy. 

```{r}
final_data %>% 
  ggplot(aes(x = fish_id, y = total_turns)) +
  geom_col(aes(fill = total_turns >= 200)) + 
  geom_label_repel(aes(label = fish_id), 
                   data = . %>% 
                     dplyr::filter(total_turns >= 200)) +
  facet_wrap(~bin) +
  scale_fill_manual(values = c("grey50", "red"))
```

I manually inspected the video tracking for these fish, and observed some jumping of the cross from the fish, indicating this high number of turns is not real and so this fish will be omitted. 

```{r}
# define fish which had the tracking issues
fish2omit <- final_data %>% 
  dplyr::filter(total_turns >= 200) %>% 
  .$fish_id %>% 
  unique
  

# remove them
final_data %<>%
  dplyr::filter(!(fish_id %in%fish2omit))

final_data_long%<>%
  dplyr::filter(!(fish_id %in% fish2omit))

final_data_summedoverbins%<>%
  dplyr::filter(!(fish_id %in% fish2omit))
```

# genotype proportions

Generally, a relatively equal number of fish per genotype treatment should be tested for a nice experiment.  There are less hets in the iron treated fish. However, since I was blinded to genotype this could just be by chance. Also, this is ok sinec this is the least interesting experimental group

```{r}
final_data %>% 
  dplyr::select(colnames(meta)) %>% 
  dplyr::distinct() %>% 
  group_by(genotype, treatment,sex) %>% 
  mutate(n = n()) %>% 
  ggplot(aes(x = genotype)) +
  geom_bar(aes(fill = sex), 
           colour = "black") +
  facet_wrap(~treatment) +
  scale_fill_viridis_d() + 
   scale_y_continuous(breaks = seq(1:26)) +
  theme(legend.position = "bottom"
        )+
  labs(title = "Number of fish per Genotype and treatment in the Y-maze analysis",
       y = "Number of fish", 
       x = "")
```


# Locomotor defect
## Overall total number of turns (summed over the whole hour)

The first readout you can obtain from a y-maze test is a locomotor phenotype. The zantiks machine is currently set up to measure the number of turns (i.e. zone changes), I will see if this is changed across genotypes and treatments. I can re-analyse the video data at a later date to formally measure total distance travelled. 

I will first look at the total number of turns summed over the whole hour.  It doesnt overerly look like there is much difference here in the whole hour. 
```{r}
final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>% 
  unique %>% 
  ggplot(aes(x = genotype,y = total_turns)) +
  geom_violin(aes(fill = genotype),
               alpha = 0.5) +
  geom_boxplot(aes(colour = genotype),
               fill = NA,
               width = 0.25,
               colour= "black") +
  geom_quasirandom(size = 2) +
  scale_fill_viridis_d(option = "viridis") +
  scale_colour_viridis_d(option = "viridis") +
  facet_wrap(~treatment) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour", 
       subtitle = "According to Treatment") 


final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>%
  unique %>%
  ggplot(aes(x = treatment,y = total_turns)) +
  geom_violin(aes(fill = genotype),
               alpha = 0.5) +
  geom_boxplot(aes(colour = genotype),
               fill = NA,
               width = 0.25,
               colour= "black") +
  geom_quasirandom(aes(shape = sex),
    size = 2) +
  scale_color_discrete_diverging() +
  scale_fill_discrete_diverging() +
  facet_wrap(~genotype) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour", 
       subtitle = "According to Treatment") 
```

I also want to look at whether there is a batch effect of test. There were a total of 12 tests (start times indicated in the plot) performed in one of two zantiks units (139 and 146). Each test contained up to 8 fish which were randomly assigned. A fair amount of variation is observed between start times, but this would be expected considering they are performed throughoutthe day, and have had sligtly different environmental conditions (e.g. ,vibrations from the construction, people talking out in the hall etc), as well as circadian differences. 

```{r}
final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  ungroup %>% 
  dplyr::select(colnames(meta), total_turns) %>%
  unique %>%
  ggplot(aes(x = reorder(start.time, behavBatch), y = total_turns)) +
  geom_boxplot(aes(),
               outlier.shape = NA,
               width = 0.25,
               alpha = 0.5,
               colour= "black") +
  geom_jitter(aes(colour = genotype),
              size = 3) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour", 
       subtitle = "According to start time of day of the test") 
```

I also had a look at whether the Genotype and Treatment groups could explain some of the apparent variation within tests. This does seem to be the case as observed in the fig below. the Genotypes can sometimes show differences. 

```{r}
final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>%
  unique %>%
  ggplot(aes(x = genotype, y = total_turns)) +
  geom_violin(aes(fill = genotype),
               alpha = 0.5) +
  geom_boxplot(aes(colour = genotype),
               fill = NA,
               width = 0.25,
               colour= "black") +
  geom_jitter(aes(shape = treatment), 
                   size = 3) +
  scale_fill_viridis_d(option = "viridis") +
  scale_colour_viridis_d(option = "viridis") +
  facet_wrap(~start.time) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour", 
       subtitle = "According to start time of day of the test")
```

## statistical test

To test whether the Genotype and/or Treatment have a significant effect overall on the total number of turns, I fitted the summed over bins data to a negative binomial generalised linear mixed effect model (negative binomial). No statistical evidence is observed here. The closest is the Treatment 100 µg Fe-citrate group, which makes sense considering the plots above show the most difference. Since the start time of the test doesnt have a logical pattern (i.e. more active in morning), I've included it in the model as a random effect. 


```{r}
# also look at the total number of turns (without the bins)
glm_timebyturns <- final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>% 
  unique  %>%
  ungroup %>% 
  glmer.nb(total_turns ~ genotype*treatment + (1|start.time),
         data = .)

Anova(glm_timebyturns) %>% 
  signif(digits = 2) %>% 
  kable %>% 
  kable_styling(full_width = F) %>% 
  row_spec(color = "red", row = c(1, 3))

print(emmeans(glm_timebyturns, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = response, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax =asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "GLM predicted total number of turns",
       x = "Genotype", 
       title = "GLM predicted total number of turns perfomred by zebrafish", 
       subtitle = "p = 0.85"
       )

```

## turns across the hour. 

I also want to look at whether the fish display changes to activity across the hour (i.e. are they more active when they are first placed in the maze?). 

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    ), 
    genotreat = paste0(genotype, "_", treatment)) %>% 
  ggplot(aes(x = binforvis, 
             y = total_turns, 
             fill = genotreat, 
             colour = genotreat)) +
  geom_boxplot(position = "dodge",
           alpha = 0.4,
           outlier.shape = NA) +
   geom_point(aes(colour = genotreat), 
              alpha = 0.4,
             position = position_jitterdodge()) +
    geom_smooth(aes(group = genotreat), se = F) +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  labs(title = "Number of turns performed by zebrafish across an hour ", 
       subtitle = "Accoring to Treatment and Genotype",
       y = "Number of turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75)
```

Within genotypes, it doesnt Looking at the changes to the total number of turns across the bins within genoytpes. The overall distibution looks simialr in each mutants, with the activity decreasing as time goes on. 

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = binforvis, y = total_turns)) +
  geom_boxplot(aes(fill = treatment),
               position = "dodge",
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(aes(colour = treatment), 
             position = position_jitterdodge()) +
  geom_smooth(aes(group = treatment, 
                  colour = treatment), 
              se = F) +
  facet_wrap(~genotype, nrow = 1, scales = "free_x")+
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1, vjust = 1)) +
  labs(title = "Number of turns performed by zebrafish across an hour ", 
       subtitle = "Accoring to Treatment and Genotype",
       y = "Number of turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75)

```

Finally, want to vis within Treatments

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = binforvis, y = total_turns)) +
  geom_boxplot(aes(fill = genotype),
               position = "dodge",
               alpha = 0.5,
               outlier.shape = NA) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~treatment, nrow = 1)+
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1, vjust = 1)) +
  labs(title = "Number of turns performed by zebrafish across an hour ", 
       subtitle = "Accoring to Treatment and Genotype",
       y = "Number of turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
  #ggsave("output/FeCit_turnsAcrossHour.png", width = 15, height = 5, units = "cm", dpi = 200, scale = 2)
```


## statistical test

To test whether the Genotype and/or Treatment have a significant effect overall on the total number of turns, I fitted the per bin data to a negative binomial generalised linear mixed effect model. Since the start time of the test doesnt have a logical pattern (i.e. mrore active in morning), I've included it in the model as a random effect. 
The bin has a highly significant effect on the total turns. This is consistent with what we have seen in the past using this test. The fish are more active when they first enter the maze and it drops off as they become more accustomed to it. The effect of genotype is also statistically signnificant. . The genotype:treatment:bin effect 



```{r }
# fit the glm
 # takes a while to run
glm_timebyturns2 <- final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>%
  mutate(bin = case_when(
    bin == 1 ~ "0-10 mins",
    bin == 2 ~ "10-20 mins",
    bin == 3 ~ "20-30 mins",
    bin == 4 ~ "30-40 mins",
    bin == 5 ~ "40-50 mins",
    bin == 6 ~ "50-60 mins"
    )) %>%
  glmer.nb(total_turns ~ genotype*treatment*bin + (1|start.time) + (1|fish_id),
         data = .)

# savethe object out and re-import it to save time later
#glm_timebyturns2 %>% saveRDS("data/ymaze/metabolomics_fam/R_objects/glm_timebyturns.rds")

# re-import this object
glm_timebyturns2 <- read_rds("data/ymaze/metabolomics_fam/R_objects/glm_timebyturns.rds")
```

Fitting this model gave some convergence issues. This is the error message:

Warning messages:
1: In checkConv(attr(opt, \"derivs\"), opt$par, ctrl = control$checkConv,  : \  Model failed to converge with max|grad| = 0.00563576 (tol = 0.002, component 1)
2: In checkConv(attr(opt, \"derivs\"), opt$par, ctrl = control$checkConv,  :
  Model failed to converge with max|grad| = 0.0136431 (tol = 0.002, component 1)"

```{r}
print("Warning messages:
1: In checkConv(attr(opt, \"derivs\"), opt$par, ctrl = control$checkConv,  : \  Model failed to converge with max|grad| = 0.00563576 (tol = 0.002, component 1)
2: In checkConv(attr(opt, \"derivs\"), opt$par, ctrl = control$checkConv,  :
  Model failed to converge with max|grad| = 0.0136431 (tol = 0.002, component 1)")
```


```{r }
an <- Anova(glm_timebyturns2) %>% 
  signif(digits = 2)

an %>% 
  kable %>% 
  kable_styling(full_width = F) %>% 
  row_spec(color = "red", row = c(1, 3, 4))

# effect of genotype
print(emmeans(glm_timebyturns2, ~ genotype), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = response)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax =asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "GLM predicted total number of turns",
       x = "Genotype", 
       title = "GLM predicted total number of turns perfomred by zebrafish", 
       subtitle = paste0("p = ", an['genotype',3])
       )

# effect of genotype * treatment
print(emmeans(glm_timebyturns2, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = response, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()
           ) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax =asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  #facet_wrap(~genotype, nrow = 1) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Predicted number of  turns averaged across bins",
       x = "Treatment", 
       title = "GLM-predicted total turns per genotype:treatment ", 
       subtitle =  paste0("p = ", an['genotype:treatment',3])
       )


emmeans(glm_timebyturns2, ~ genotype * treatment*bin, 
        type ="response") %>% 
  as_tibble() %>% 
  mutate(
    geno_treat = paste(genotype, treatment)
    ) %>% 
  dplyr::filter(
    !grepl(geno_treat, pattern = "het .+ Fe")
    ) %>% 
  ggplot(
    aes(x = bin, y = response, colour = geno_treat)
    ) +
  geom_point(
    aes(fill = geno_treat), 
    alpha = 0.5,
    size = 2,
    position = position_dodge(width = 0.5), 
    ) +
  geom_line(
    aes(group = geno_treat), 
    position = position_dodge(width = 0.5)
  ) +
  geom_errorbar(
    aes(ymin = asymp.LCL, ymax =asymp.UCL),
    width = 0.5,
    size = 0.5,
    position = position_dodge(width = 0.5)
    ) +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(
    y = "model-predicted average\nnumber of turns per bin",
    x = "Treatment", 
    title = "Activity of zebrafish in a ymaze ", 
    subtitle =  paste0("p = ", an['genotype:treatment:bin',3])
  ) +
 theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom")
      
```

## actual total distance travelled 

I ran the videos through ethovision to assess the actual total dstance travelled. Exported the tracked distances per zone in 2 second time bins. I tried 1 second bins but it wouldnt let me export this on ethovision due to memory issues. 

```{r}
distanceData <- read_excel("data/ymaze/metabolomics_fam/Ethovision_analysis/2s_bins_by_zone_Statistics-KB_2023_05_05_naglu_homxhet_6m_metabolomicsFam_ymaze_reanalysis.xlsx")

distanceData %<>%
  set_colnames(c("delete", "Trial", "Arena", "bin", "zone", 'distance', 'velocity')) %>% 
  dplyr::select(-delete) %>% 
  mutate(Trial = str_remove(Trial, pattern = "Trial     "))

# make a df which contains the bin numbers
binConvert <- distanceData$bin %>% 
  unique %>% 
  as_tibble() %>% 
  set_colnames("bin") %>% 
  mutate(binNumber = rownames(.) %>% as.double(), 
         bins6 = case_when( 
           binNumber >= 1 & binNumber <= 300 ~ 1, 
           binNumber >= 301 & binNumber <= 600 ~ 2, 
           binNumber >= 601 & binNumber <= 900  ~ 3,
           binNumber >= 901 & binNumber <= 1200 ~ 4, 
           binNumber >= 1201 & binNumber <= 1500 ~ 5, 
           binNumber >= 1501 & binNumber <= 1800  ~ 6 
         ) %>% as.character() 
         ) 

total_distance_data <- distanceData %>% 
  dplyr::filter(zone == "In Arena")  %>% 
  mutate(distance = as.numeric(distance), 
         distance = case_when(
           is.na(distance) ~ 0, 
           TRUE ~ distance
         )) %>% 
  left_join(binConvert) %>% 
  group_by(bins6, Trial, Arena) %>% 
  mutate(total_distance = sum(distance)) %>% 
  dplyr::select(-c(bin, distance, velocity, binNumber)) %>% 
  unique()

total_distance_data %<>% 
  dplyr::rename(ymazePosition = Arena, 
                behavBatch = Trial) %>% 
  mutate(ymazePosition = str_remove(ymazePosition, 
                                    pattern = "Arena ") # match to the metadata file, 
) %>% 
  left_join(meta, by = c("ymazePosition", "behavBatch")) %>% 
  dplyr::filter(genotype %in% c("het", "hom"))  
```

#### total distance travelled

There is definitely a trial effect here. Fish are less active at the end of the day.

```{r}
total_distance_data %>% 
  group_by(fish_id) %>% 
  mutate(total_distance = sum(total_distance)) %>% 
  dplyr::select(-bins6) %>% 
  unique %>% 
  ggplot(aes(x = behavBatch, y = total_distance)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = sex, colour = behavBatch), 
             size = 3, 
             position = position_jitter())
  facet_wrap(~treatment)
```

Looking at the raw data by genotype and treatment, not a massive difference in the saline group.. 

```{r}
total_distance_data %>% 
  group_by(fish_id) %>% 
  mutate(total_distance = sum(total_distance)) %>% 
  dplyr::select(-bins6) %>% 
  unique %>% 
  ggplot(aes(x = genotype, y = total_distance)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = sex, colour = genotype), 
             size = 3, 
             position = position_jitter()) +
  facet_wrap(~treatment)
```


#### total distance travelled per 10 min bin

```{r}
total_distance_data %>% 
  mutate(genotreat = paste0(genotype, treatment)) %>% 
  ggplot(aes(x = bins6, 
             y = total_distance/1000, 
             fill = genotreat, 
             colour = genotreat)) +
  geom_boxplot(position = "dodge",
           alpha = 0.4,
           outlier.shape = NA) +
   geom_point(aes(colour = genotreat), 
              alpha = 0.4,
             position = position_jitterdodge()) +
   # geom_smooth(aes(group = genotreat), se = F) +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  labs(title = "Number of turns performed by zebrafish across an hour ", 
       subtitle = "Accoring to Treatment and Genotype",
       y = "Distance travelled (m)") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75)
```

#### stat test

```{r}
# check histyogram
hist(total_distance_data$total_distance)
```
Looks a bit left skewed. 

Try transforming by log, 
```{r}
hist(log(total_distance_data$total_distance))
```

This skews it to the right

```{r}
hist(sqrt(total_distance_data$total_distance))
```

This looks better. 

Now fit linear mixed model
```{r}
distance_fit <- total_distance_data %>% 
  lmer(sqrt(total_distance) ~ (genotype*treatment*bins6) + (1|`start.time`) + (1|fish_id),
           data = .)

# look at random effects
summary(distance_fit) 

# Check model assumptions. all looks ok
check_model(distance_fit)

# perform wald test to tests for significance
Anova(distance_fit) %>% pander::pander()
```

#### Vis
No sig effect of genotype, or treatment
```{r}
# look at the graphs
emmeans(distance_fit, ~ genotype * treatment, type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = response, colour = genotype)) +
   geom_col(
    aes(fill = genotype), 
    alpha = 0.5,
    position = position_dodge(width = 1)
    ) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    position = position_dodge(width = 1), 
    width = 0.5
    ) +
  theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
    plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
    ) +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Average distance travelled (cm) per bin",
       x = "Treatment", 
       title = "Total turns", 
      subtitle = paste("p =", Anova(distance_fit)["genotype:treatment", 3] %>% signif(2))
  )
    
  
print(emmeans(distance_fit, ~ genotype * treatment*bins6), type ="response") %>% 
  as_tibble() %>% 
  ggplot(
    aes(x = bins6, y = response, colour = genotype)
    ) +
  geom_point(
    alpha = 0.5,
    position = position_dodge(width = 0.75)
    ) +
  geom_line(
    aes(group = genotype), 
    position = position_dodge(width = 0.75)
  ) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.5,
    size = 0.5,
    position = position_dodge(width = 0.75)
    ) +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  facet_wrap(~treatment) 
```

### Time moving from the distance data
Doesnt seem like there is a sig effect of genotype for total distance travelled. However, maybe the mutants will spend more time moving.

```{r}
distancedatatall <- distanceData %>% 
  dplyr::filter(zone == "In Arena")  %>% 
  mutate(distance = as.numeric(distance), 
         distance = case_when(
           is.na(distance) ~ 0, 
           TRUE ~ distance
         )) %>% 
  left_join(binConvert) %>% 
  dplyr::rename(ymazePosition = Arena, 
                behavBatch = Trial) %>% 
  mutate(ymazePosition = str_remove(ymazePosition, 
                                    pattern = "Arena ") # match to the metadata file, 
  ) %>% 
  left_join(meta, by = c("ymazePosition", "behavBatch")) %>% 
  dplyr::filter(genotype %in% c("het", "hom"))
```

First, need to define a threshold of whether a fish is moving or not
Having a look at some videos, and the data of some fish below. I think a threshold of < 0.5 cm/s (i.e. 1 cm per 2 second time bin) should be a decent threshold to consider a fish moving or not. 

```{r}
distancedatatall %>% 
  dplyr::filter(fish_id %in% 1:8, 
                binNumber %in% c(1:5)) %>% 
  ggplot(aes(x = binNumber, y = distance)) +
  geom_line(aes(group = fish_id, colour = fish_id), 
            size = 4) 
```

```{r}
movingThreshold = 1
```

First, will plot out the number of fish considered moving per genotype in the saline group only
```{r}
distancedatatall %>% 
  mutate(moving = case_when(
    distance >= 1 ~ "moving", 
    TRUE ~ "not moving")
  ) %>% 
  dplyr::filter(treatment == "0.85% saline", 
                moving == "moving") %>% 
  ggplot(aes(x = binNumber)) +
  geom_bar(aes(fill = genotype), position = "dodge") +
  ggtitle("Number of fish considered moving per genotype (saline only)")
```

Looks like there might be some differences here. a few more homs moving at the start and more so at the end, and more hets moving in the middle

also will have a look at the iron treated group

note there were less hets to begin with, and so they look like there are less 
```{r}
distancedatatall %>% 
  mutate(moving = case_when(
    distance >= 1 ~ "moving", 
    TRUE ~ "not moving")
  ) %>% 
  dplyr::filter(treatment != "0.85% saline", 
                moving == "moving") %>% 
  ggplot(aes(x = binNumber)) +
  geom_bar(aes(fill = genotype), position = "dodge") +
  ggtitle("Number of fish considered moving per genotype (iron only)")
```

To analyse this, will calculate the proportion of time spent moving per 20 min time bin

```{r}
time_movingData <- distancedatatall %>% 
  mutate(time_moving = case_when(
    distance >= 1 ~ 2, # 2 seconds moving 
    TRUE ~ 0) # not moving
  ) %>% 
  left_join(binConvert) %>% 
  group_by(bins6, fish_id) %>% 
  mutate(total_time_moving = sum(time_moving),
         prop_moving = sum(time_moving)/1200) %>% #total time moving / 1200 s (i.e. 20 mins per bin)
  dplyr::distinct(fish_id, bins6, .keep_all = T)
```

#### plot time moving per bin
```{r}
time_movingData %>% 
  ggplot(
    aes(x = bins6, y = prop_moving, colour = genotype)
  ) +
  geom_boxplot(
    outlier.shape = NA
    ) +
  geom_jitter(
    position = position_dodge(width = 1)
    ) +
  geom_smooth(
    aes(group = genotype), 
    method = "lm", 
    se = F
  ) +
  facet_wrap(~treatment)
```


```{r}
hist(time_movingData$prop_moving )
```


## are the mutants more likely to be "non responders"

Some fish may not repsond to this test, So first I will have a look if there are any fish which seem to just sit there and not move for the whole hour. Here, I will define a fish to be a "non-responder" if they perfomed less than 60 turns in the test (so less than 1  per minuye). 

First, I will plot the totalturns per bin per fish as a line plot. There does seem to be some fish which show a relatively straight line around 10 total turns. 

```{r}
final_data %>% 
  ggplot(aes(x = bin, y = total_turns)) +
  geom_line(aes(colour = fish_id), show.legend = F) +
  facet_wrap(~genotype*treatment, nrow = 1)
```

Only 2 fish here are not responding to the test, both iron treated. COnsidering this low number, omitting them will not make a large differercne to any any statistcial tests and so I will retain them. 

```{r}
final_data %>% 
  dplyr::select(!grep(colnames(final_data), pattern = "[L|R]{4}")) %>% #unsleect the tetras cols to make my life easier right now. 
  group_by(fish_id) %>% 
  mutate(nonresp = sum(total_turns) < 60) %>% 
  dplyr::select(fish_id, nonresp) %>% 
  unique %>% 
  dplyr::filter(nonresp == TRUE) %>% 
  left_join(meta %>% dplyr::select(fish_id, genotype, treatment)) %>% 
  kable %>% 
  kable_styling(full_width = F)
```

# time spent in each zone of the Y-maze

I next will assess whether fish in each maze spend more or less time in each zone of the Y-maze (i.e. in each arm of the maze or the middle). This is also kind of representitve of locomotion, as they might spend longer in each arm of the maze if the swim speed was slower. 

In the plot below, the fish appear to spend less time in zone 4. This can be explained as zone 4 is the middle zone and the fish generally swim straight through it.  

```{r}
read_csv("data/ymaze/metabolomics_fam/processed_data/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::select(fish_id, bin, zone, time_in_zone) %>% 
  left_join(meta) %>%
  dplyr::filter(genotype %in% c("het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  group_by(fish_id, zone) %>%
  mutate(total_timeInZone = sum(time_in_zone), 
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(fish_id, zone, .keep_all = TRUE) %>%
  ggplot(aes(x = treatment, y = total_timeInZone/60)) +
  geom_quasirandom(aes(colour = genotype)
                  ) +
  geom_boxplot(aes(fill = genotype),
               outlier.shape = NA,
                alpha = 0.5) +
  facet_wrap(~zone, nrow = 1) +
  scale_y_log10() +
  scale_fill_viridis_d(end = 0.75) +
  scale_colour_viridis_d(end = 0.75) +
  easy_rotate_x_labels(angle = -45) +
  labs(y = "Total time spent in each zone (mins, log scale)", 
       title = "Total time spent in each zone")
```

I was curious to see whether which maze the fish were in (i.e. top left, middle etc) would have an effect on whether they spend more or less time in one of the arms of the mazes. There are 8 ymazes in each zantiks unit. inspection of the total time spent in each zone of the maze across the 8 possible positions in the zantiks unit didnt reveal any trends. 

There might have been something in position 6, zone 4. But this is only 2 data points and so not really reliable

```{r}
read_csv("data/ymaze/metabolomics_fam/processed_data/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::select(fish_id, bin, zone, time_in_zone) %>%
  left_join(meta) %>%
  dplyr::filter(genotype %in% c("het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  group_by(fish_id, zone) %>%
  mutate(total_timeInZone = sum(time_in_zone), 
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(total_timeInZone, .keep_all = TRUE) %>%
  ggplot(aes(x = zone, y = total_timeInZone/60)) +
  geom_quasirandom(aes(colour = genotype, 
                       shape = treatment), 
                   size = 2
                  ) +
  geom_boxplot(aes(fill = genotype),
               outlier.shape = NA,
                alpha = 0.5) +
  facet_wrap(~ymazePosition) +
  scale_y_log10() +
  scale_fill_viridis_d(end = 0.75) +
  scale_colour_viridis_d(end = 0.75) +
  easy_rotate_x_labels(angle = -45) +
  labs(y = "Total time spent in each zone (mins, log scale)", 
       title = "Total time spent in each zone", 
       subtitle = "accoring to position in the ymaze")
```

I alslo wanted to look at the average time spent in each zone. 

```{r}
read_csv("data/ymaze/metabolomics_fam/processed_data/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::select(fish_id, bin, zone, time_in_zone) %>%
  left_join(meta) %>%
  group_by(fish_id, zone) %>%
  dplyr::filter(genotype %in% c("het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  mutate(aveTimeInZone = mean(time_in_zone), 
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(aveTimeInZone, .keep_all = TRUE) %>%
  ggplot(aes(x = treatment, y =aveTimeInZone)) +
  geom_quasirandom(aes(colour = genotype)
                  ) +
  geom_boxplot(aes(fill = genotype),
               outlier.shape = NA,
                alpha = 0.5) +
  facet_wrap(~zone, nrow = 1) +
  scale_y_log10() +
  scale_fill_viridis_d(end = 0.75) +
  scale_colour_viridis_d(end = 0.75) +
  easy_rotate_x_labels(angle = -45) +
  labs(y = "Average time spent in each zone (mins, log scale)", 
       title = "Average time spent in each zone")

```

## Statistical test

Here, I fit the average time spent in each zone of the maze to a linear mixed effect model. The `Genotype x treatmetn x zone` effect is not significant, meaning there is not difference between the mutants and Treatment groups. 

```{r}

fit <- 
  read_csv("data/ymaze/metabolomics_fam/processed_data/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::filter(!(fish_id %in% fish2omit)) %>% 
  dplyr::filter(time_in_zone >=0) %>%  # omit the buggy shit with the negative times
  dplyr::select(fish_id, bin, zone, time_in_zone) %>% 
  left_join(meta) %>%
  dplyr::filter(genotype %in% c("het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  group_by(fish_id, zone) %>%
  mutate(total_timeInZone = sum(time_in_zone),
         logtimezone = log(total_timeInZone),
         zone = paste0("zone ", zone)
         ) %>%
  dplyr::distinct(fish_id, zone, .keep_all = TRUE) %>% 
  lmer(logtimezone ~ (genotype + treatment + sex + zone)^3  + (1|`start.time`),
    data = .)

check_model(fit)


```

Some assumptions not fitting here. Look into later

# check for handedness

Fontana et al. (https://doi.org/10.1007/s10071-019-01296-9, Matt Parker's group) showed that fish sometimes show a behavioural lateralisation (i.e. handedness). If fish show this, then they would perform less alternation tetragrams not due to working memory.

The plot below circles each of the L_R bias groups. 

```{r}
# make the LR bias object
LR_Bias <- final_data %>%
  dplyr::select(L, R, total_turns, fish_id) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns),
         L_R_bias = case_when( #consider more than 60% of the time performing a left or right turn to be a bias
           L/total_turns > 0.6 ~ "Left",
           R/total_turns > 0.6 ~ "Right",
           TRUE ~ "Neither"
         )) %>%
  dplyr::select(fish_id, L_R_bias) %>%
  unique() %>%
  mutate(L_R_bias = factor(L_R_bias,
                           levels = c("Neither", "Left", "Right"))
  )
```


```{r}
ggarrange(
final_data %>%
  left_join(LR_Bias) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns)
  ) %>%
  ggplot(aes(L, R)) +
  geom_point(aes(shape = L_R_bias, colour = genotype),
             size = 4) +
  geom_mark_ellipse(aes(fill = L_R_bias, label = L_R_bias),
                 alpha = 0.2, 
                 con.cap = 0) +
  labs(title = "By Genotype") +
  scale_color_viridis_d(end = 0.75) +
  theme(legend.position = "left", 
        aspect.ratio = 1) +
  scale_fill_viridis_d(option = "plasma"), 

final_data %>%
  left_join(LR_Bias) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns)
  ) %>%
  ggplot(aes(L, R)) +
  geom_point(aes(shape = L_R_bias, colour = treatment),
             size = 4) +
  geom_mark_ellipse(aes(fill = L_R_bias, label = L_R_bias),
                 alpha = 0.2, 
                  con.cap = 0)+
  labs(title = "By Treatment") +
  scale_color_viridis_d(end = 0.75) +
  scale_fill_viridis_d(option = "plasma") +
  theme(legend.position = "right", 
        aspect.ratio = 1)
)
```

The overall propotions of fish showing left, right or no bias is simialr across the 4 experimental groups. 

```{r}
final_data %>%
  left_join(LR_Bias) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns), 
         genotreat = paste0(genotype, "_", treatment)
        
  ) %>% 
  ggplot(aes(x = genotreat, fill = L_R_bias )) +
  geom_bar()
```

# test for changes to alternation

Cleal et al. showed that zebrafish naturally perform more of the alternation tetragrams (LRLR and RLRL) in a Y-maze. Here, we actually see more reps that alts. I will look at this more closely later. 

```{r}
final_data_summedoverbins %>%
  dplyr::distinct(x, .keep_all = T) %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               fill = NA
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "bottom")  +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

We can also overlay the genotype boxplots as shown below. Looks like the heterozyous and homozygous fish perform more alternations than the WT fish. I will look into this more later in the analysis

```{r}
final_data_summedoverbins %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype),
               alpha = 0.5,
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "bottom")  +
  facet_wrap(~treatment, ncol = 1) +
  easy_rotate_x_labels(angle = -45) +
  annotate("rect", # add some boxes aeround the alts 
           xmin = 5.5, xmax = 6.5, 
           ymin = -1, ymax = 600, 
             alpha = 0, color= "red") +
  annotate("rect", 
           xmin = 10.5, xmax = 11.5, 
           ymin = -1, ymax = 200,
           alpha = 0, color= "red") +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

The alternation tetragrams are the tetragram of interest (the measure of working memory). Below indicates the number of tetragrams performed by zerbafish across the 6 x 10 min blocks of the hour they spent in the maze.

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = treatment, y = alts)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Frequency of alternation tetragrams (LRLR + RLRL)") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
  
```

We can also display this as the *relative* amount of alternation tetragrams performed by zebrafish in a 1 hour search period. This will control for how active each fish is. Again, fish 18 and 24 looks like outliers.

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = treatment, y = rel_alts)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Relative number of alternation tetragrams\n(LRLR + RLRL) / total_turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
```

Finally, I will now test for alternation changes using a generalised linear mixed effect model (beta-binomial distribution). We use this because it is count data which is over-dispersed, and fixed and random effects are included. The link function is logit.

No significant effects are observed on working memory. Only the `L_R_bias` term is significant, this is to be expected, as they would probably be performing more repitiions. 

The `bin:Genotype` effect is close (ish) to statistical significance. Meaning that this might have something there. but this does not take into account the Treatment group.   

Note that I have ignored the effect of Sex here. We have never really seen a Sex effect in all of our ymaze analyses.

```{r}
glm <-
  final_data %>%
  left_join(LR_Bias) %>%
  dplyr::filter(sex == "f") %>% 
  mutate(
    non_alts = total_turns - alts,
    bin = as.factor(bin)
  ) %>%
  glmmTMB(
    cbind(alts, non_alts) ~ (bin + genotype + treatment)^3 + L_R_bias + (1|start.time) + (1|fish_id),
    family = betabinomial(),
    data = .
  )

an.alts <- Anova(glm) %>%
  as.data.frame() %>%
  dplyr::rename(pval = `Pr(>Chisq)`) 

an.alts %>%   
  kable() %>%
  kable_styling(full_width = FALSE) %>% 
  row_spec(row = 4, bold = TRUE)
```

## Vis 
### genotype

The naglu homs perform almost sig. more alts than wts. This is averaged out across treatments and bins. 

```{r}
print(emmeans(glm, ~ genotype ), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = prob, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "treatment", 
       title = "GLM predicted probability of zebrafish performing an alternation\ntetragram due to Genotype and Treatment", 
       subtitle = paste0("effect of genotype: p = ", an.alts['genotype',3] %>% signif(2))
       )
```


### genotype x treatment

The effect of genotype x treatment is ns. Iron supp seemed to make the hets perform worse. 

```{r}
print(emmeans(glm, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = prob, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "treatment", 
       title = "GLM predicted probability of zebrafish performing an alternation\ntetragram due to Genotype and Treatment", 
       subtitle = paste0("effect of genotype:treatment p = ", an.alts['genotype:treatment',3] %>% signif(2))
       )
```


### bin x Genotype x Treatment

The herts semed to perform worse after iron trearment. 

```{r}
print(emmeans(glm, ~ genotype * treatment * bin), type = "response") %>% 
  as_tibble() %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(
    aes(x = binforvis, y = prob, colour = genotype)
    ) +
  geom_point(
    aes(fill = genotype), 
    alpha = 0.5,
    size = 3,
    # width = 0.75,
    position = position_dodge(width = 0.75)
    ) +
  geom_errorbar(
    aes(ymin = asymp.LCL, ymax = asymp.UCL),
    # width = 0.125,
    size = 1,
    position = position_dodge(width = 0.75)
  ) +
  geom_line(
    aes(group = genotype), 
    position = position_dodge(width = 0.75)
  ) +
    facet_wrap(~treatment, nrow = 1) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "Time interval", 
       title = "GLM predicted probability of zebrafish performing an alternation\ntetragram due to Genotype and Treatment", 
       subtitle = paste0("effect of genotype:treatment:bin p = ", an.alts['bin:genotype:treatment',3] %>% signif(2))
       )
```

### L or R bias
```{r}
print(emmeans(glm, specs = "L_R_bias"), type = "response") %>%
  as_tibble() %>%
  ggplot(aes(L_R_bias, prob, colour = L_R_bias)) +
  geom_col(aes(fill = L_R_bias),
           alpha = 0.5,
           position = position_dodge(width = 0.5)) +
  geom_errorbar(
    aes(ymin = asymp.LCL, ymax = asymp.UCL),
    width = 0.25,
    size = 1,
    position = position_dodge(width = 0.25)
    ) +
  ylab("Estimated probability of alternation") +
  xlab("Time interval") +
  theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45)
    ) +
  scale_y_continuous(limits = c(0,0.4)) +
  scale_color_viridis_d(end = 0.8, option = "viridis") +
  scale_fill_viridis_d(end = 0.8, option = "viridis") +
  ggtitle("GLM predicted probability of zebrafish performing an alternation\ntetragram due to having a LR bias",
          subtitle = paste0("Effect of L or R Bias p = ", an.alts["L_R_bias", 3] %>% signif(2), "\naveraged out over Genotypes, Treatments and bins")
  )
```

# test for changes in repetitions

Repetitions are a sign of stress. Matt Parker says he sees increased repetitions when fish are pre-treated with a chemogenic stressor. Looking at the total number of tetragrams performed, our fish in this exp seem to be performing more reps.  

```{r}
final_data_summedoverbins %>%
  dplyr::distinct(fish_id, tetras, .keep_all = T) %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               fill = NA
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "none")  +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

Same graph but overlaid genotypes
```{r}
final_data_summedoverbins %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype),
               alpha = 0.5,
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "bottom")  +
  facet_wrap(~treatment, ncol = 1) +
  easy_rotate_x_labels(angle = -45) +
  annotate("rect", # add some boxes aeround the reps 
           xmin = 0.5, xmax = 1.5, 
           ymin = -1, ymax = 600, 
             alpha = 0, color= "red") +
  annotate("rect", 
           xmin = 15.5, xmax = 16.5, 
           ymin = -1, ymax = 600,
           alpha = 0, color= "red") +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = treatment, y = reps)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Frequency of repetition tetragrams (LLLL + RRRR)") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
  
```

We can also display this as the *relative* amount of repetition tetragrams performed by zebrafish in a 1 hour search period. This will control for how active each fish is.

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = treatment, y = rel_reps)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Relative number of repetition tetragrams\n(LLLL + RRRR) / total_turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
```

I fitted the over-bins data to another generalised linear mixed effect model (beta-binomial distribution), this time compariing the reps vs non-reps (LLLL + RRRR). 

Only the LR Bias term is significant. This is also expected. 

```{r}
glm_reps <- final_data %>%
  left_join(LR_Bias) %>%
  mutate(
    non_reps = total_turns - reps,
    bin = as.factor(bin)
  ) %>%
  glmmTMB(
    cbind(reps, non_reps) ~ (bin + genotype + treatment)^3 + L_R_bias + (1|start.time) + (1|fish_id),
    family = betabinomial(),
    data = .
  )

glm_reps %>%
  Anova() %>%
  dplyr::rename(pval = `Pr(>Chisq)`) %>%
  kable() %>%
  kable_styling(full_width = FALSE) %>% 
  row_spec(row = 4, bold = TRUE)
```

### genotype x treatment

The effect of genotype x treatment is not too far off statistical significance (p = 0.17) and is trending towards a rescue. 

```{r}
print(emmeans(glm_reps, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = prob, colour = treatment)) +
  geom_col(aes(fill = treatment), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of repetitions\n(LLLL + RRRR)",
       x = "Genotype", 
       title = "GLM predicted probability of zebrafish performing an repetition\ntetragram due to Genotype and Treatment", 
       subtitle = "effect of genotype*treatment p = 0.04"
       )
```

## effect of Genotype x Treatment x bin

```{r, fig.height=10}
print(emmeans(glm_reps, ~ genotype * treatment * bin), type = "response") %>% 
  as_tibble() %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = binforvis, y = prob, colour = genotype)) +
  geom_col(aes(fill =genotype), 
           alpha = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge()) +
  facet_wrap(~treatment, nrow = 1) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "Time interval", 
       title = "GLM predicted probability of zebrafish performing an repetition\ntetragram due to Genotype and Treatment", 
       subtitle = "Effect of genotype*treatment*bin p = 0.75"
       )
```

## L or R bias
```{r}
print(emmeans(glm_reps, specs = "L_R_bias"), type = "response") %>%
  as_tibble() %>%
  ggplot(aes(L_R_bias, prob, colour = L_R_bias)) +
  geom_col(aes(fill = L_R_bias),
           alpha = 0.5,
           position = position_dodge(width = 0.5)) +
  geom_errorbar(
    aes(ymin = asymp.LCL, ymax = asymp.UCL),
    width = 0.25,
    size = 1,
    position = position_dodge(width = 0.25)
    ) +
  ylab("Estimated probability of alternation") +
  xlab("Time interval") +
  theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45)
    ) +
  scale_y_continuous(limits = c(0,0.5)) +
  scale_color_viridis_d(end = 0.8, option = "viridis") +
  scale_fill_viridis_d(end = 0.8, option = "viridis") +
  ggtitle("GLM predicted probability of zebrafish performing an repetition\ntetragram due to having a LR bias",
          subtitle = "Effect of L or R Bias p = 0.000008\naveraged out over Genotypes, Treatments and bins")
```


# Conclusion

```{r}
# export data for later:
final_data %>% 
  saveRDS("output/R_objects/FeCit_metabolomicsFam.rds")
```


# plot for SCF talk

```{r}
a <- emmeans(distance_fit, ~ genotype * treatment, type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = response, colour = genotype)) +
   geom_col(
    aes(fill = genotype), 
    alpha = 0.5,
    position = position_dodge(width = 1)
    ) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    position = position_dodge(width = 1), 
    width = 0.5
    ) +
  theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
    plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
    ) +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Average distance travelled (cm) per bin",
       x = "Treatment", 
       title = "Total distnace travelled", 
      subtitle = paste("p =", Anova(distance_fit)["genotype:treatment", 3] %>% signif(2))
  )

b <- 
  emmeans(glm, ~ genotype * treatment, type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = prob, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = asymp.LCL , ymax = asymp.UCL ),
                width = 0.5,
                position = position_dodge(1)) +
  #facet_wrap(~sex) +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "Treatment",
      title = "Alternations", 
       subtitle = "p = 0.1"
       ) +
 theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
    plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
    )

c <- 
  print(emmeans(glm_reps, ~ genotype * treatment), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = treatment, y = prob, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge(width = 1)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.5,
                position = position_dodge(width = 1)) +
 theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
    plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
    ) +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Repetitions\n(LLLL + RRRR)",
       x = "Treatment", 
       title = "Repetitions", 
       subtitle = "p = 0.04"
       )

ggarrange(a,b,c, 
          common.legend = T, 
          nrow = 1) +
  ggsave("output/plotsforSCFtalk/behaviourFeCitFullExp2.png", 
         width = 20, height = 10, units = "cm", 
         scale = 1.5)
```

```{r}
final_data_summedoverbins %>% 
  dplyr::select(fish_id, tetras, x) %>% 
  spread(key = "tetras", value = "x") %>% 
  column_to_rownames("fish_id") %>% 
  prcomp %>% 
  autoplot(data = tibble(fish_id = rownames(.$x)) %>%
      left_join(meta) %>% 
        mutate(genotreat = paste0(genotype, "_", treatment)),
    colour = "genotreat", 
    shape = "sex",
    alpha = 0.5,
    size = 6)
```



